{% comment %}
  apple-style-navigation.liquid

  This snippet creates an Apple-style navigation for Shopify that uses your store's data
  - Uses main menu link list for primary navigation
  - Uses additional link lists for dropdowns
  - Dynamically generates dropdown menus based on your Shopify link lists
{% endcomment %}

<header class="bg-white shadow-sm relative">
  <!-- Top Navigation Bar -->
  <div class="w-full flex justify-between items-center px-4 py-3 border-b border-gray-200">
    <!-- Store Logo -->
    <a href="/" class="text-gray-900">
      {% if settings.logo != blank %}
        <img
          width="250px"
          height="100px"
          src="{{ settings.logo | image_url: width: 250 }}"
          alt="{{ shop.name }}"
          class="h-64 w-24"
        >
      {% else %}
        <span class="text-xl font-bold">{{ shop.name }}</span>
      {% endif %}
    </a>

    <!-- Main Navigation -->
    <nav class="hidden md:flex">
      {% for link in linklists['main-menu'].links %}
        {% assign dropdown_handle = link.handle | append: '-dropdown' %}
        {% assign has_dropdown = false %}
        {% if linklists[dropdown_handle] != blank %}
          {% assign has_dropdown = true %}
        {% endif %}

        <div class="group relative">
          <a href="{{ link.url }}" class="text-sm text-gray-700 hover:text-gray-900 px-4 py-2 inline-block">
            {{- link.title -}}
          </a>

          {% if has_dropdown %}
            <div class="hidden group-hover:block absolute left-0 w-screen bg-white shadow-lg z-50" style="top: 100%;">
              <div class="py-8 px-8 max-w-7xl mx-auto">
                {% comment %}
                  Check for the dropdown structure type - different structures for different sections
                {% endcomment %}
                {% if link.handle == 'store' %}
                  <div class="grid grid-cols-3 gap-8">
                    <!-- Shop Column -->
                    <div>
                      <h3 class="text-gray-900 font-medium mb-4">Shop</h3>
                      <ul class="space-y-3">
                        {% for childlink in linklists[dropdown_handle].links %}
                          {% if childlink.handle contains 'shop-' %}
                            <li>
                              <a href="{{ childlink.url }}" class="text-gray-700 hover:text-gray-900">
                                {{- childlink.title -}}
                              </a>
                            </li>
                          {% endif %}
                        {% endfor %}
                      </ul>
                    </div>

                    <!-- Quick Links Column -->
                    <div>
                      <h3 class="text-gray-900 font-medium mb-4">Quick Links</h3>
                      <ul class="space-y-3">
                        {% for childlink in linklists[dropdown_handle].links %}
                          {% if childlink.handle contains 'quick-' %}
                            <li>
                              <a href="{{ childlink.url }}" class="text-gray-700 hover:text-gray-900">
                                {{- childlink.title -}}
                              </a>
                            </li>
                          {% endif %}
                        {% endfor %}
                      </ul>
                    </div>

                    <!-- Shop Special Stores Column -->
                    <div>
                      <h3 class="text-gray-900 font-medium mb-4">Shop Special Stores</h3>
                      <ul class="space-y-3">
                        {% for childlink in linklists[dropdown_handle].links %}
                          {% if childlink.handle contains 'special-' %}
                            <li>
                              <a href="{{ childlink.url }}" class="text-gray-700 hover:text-gray-900">
                                {{- childlink.title -}}
                              </a>
                            </li>
                          {% endif %}
                        {% endfor %}
                      </ul>
                    </div>
                  </div>

                {% elsif link.handle == 'mac' or link.handle == 'ipad' or link.handle == 'iphone' %}
                  <div class="grid grid-cols-4 gap-6">
                    {% comment %}
                      Group links by their metadata (assumes using link_group metafield)
                      If you don't have metafields, you can use tags or handle prefixes
                    {% endcomment %}
                    {% assign link_groups = '' | split: '' %}
                    {% for childlink in linklists[dropdown_handle].links %}
                      {% assign handle_parts = childlink.handle | split: '-' %}
                      {% if handle_parts.size > 1 %}
                        {% assign group_name = handle_parts | first %}
                        {% unless link_groups contains group_name %}
                          {% assign link_groups = link_groups | push: group_name %}
                        {% endunless %}
                      {% endif %}
                    {% endfor %}

                    {% for group in link_groups %}
                      <div>
                        <h3 class="text-gray-900 font-medium mb-4">{{ group | capitalize }}</h3>
                        <ul class="space-y-3">
                          {% for childlink in linklists[dropdown_handle].links %}
                            {% if childlink.handle contains group %}
                              <li>
                                <a href="{{ childlink.url }}" class="text-gray-700 hover:text-gray-900">
                                  {{- childlink.title -}}
                                </a>
                              </li>
                            {% endif %}
                          {% endfor %}
                        </ul>
                      </div>
                    {% endfor %}

                    {% comment %}
                      If no groups were found, just display all links
                    {% endcomment %}
                    {% if link_groups.size == 0 %}
                      <div>
                        <ul class="space-y-3">
                          {% for childlink in linklists[dropdown_handle].links %}
                            <li>
                              <a href="{{ childlink.url }}" class="text-gray-700 hover:text-gray-900">
                                {{- childlink.title -}}
                              </a>
                            </li>
                          {% endfor %}
                        </ul>
                      </div>
                    {% endif %}
                  </div>

                {% else %}
                  <!-- Default dropdown layout -->
                  <ul class="grid grid-cols-3 gap-4">
                    {% for childlink in linklists[dropdown_handle].links %}
                      <li>
                        <a href="{{ childlink.url }}" class="text-gray-700 hover:text-gray-900">
                          {{- childlink.title -}}
                        </a>
                      </li>
                    {% endfor %}
                  </ul>
                {% endif %}
              </div>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </nav>

    <!-- Search and Cart Icons -->
    <div class="flex items-center space-x-4">
      <a href="/search" class="text-gray-700 hover:text-gray-900">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M19.7071 18.2929L15.2071 13.7929C16.3924 12.3097 17.0024 10.4338 16.9999 8.5C16.9999 6.91775 16.5308 5.37104 15.6518 4.05544C14.7727 2.73985 13.5233 1.71447 12.0615 1.10896C10.5997 0.503466 8.99113 0.34504 7.43928 0.653721C5.88743 0.962403 4.46197 1.72433 3.34315 2.84315C2.22433 3.96197 1.4624 5.38743 1.15372 6.93928C0.84504 8.49113 1.00346 10.0997 1.60897 11.5615C2.21447 13.0233 3.23985 14.2727 4.55544 15.1518C5.87104 16.0308 7.41775 16.5 9 16.5C10.9338 16.5024 12.8097 15.8925 14.2929 14.7071L18.7929 19.2071C18.8834 19.2976 18.9914 19.3697 19.1104 19.4194C19.2294 19.4691 19.3571 19.4955 19.4857 19.4971C19.6144 19.4988 19.7427 19.4757 19.8629 19.4292C19.983 19.3826 20.0927 19.3134 20.1854 19.2254C20.278 19.1373 20.3524 19.0319 20.4038 18.9144C20.4553 18.797 20.4829 18.6701 20.485 18.5415C20.4872 18.4129 20.4639 18.2852 20.417 18.166C20.3701 18.0468 20.3007 17.9388 20.2121 17.8479L19.7071 18.2929ZM3 8.5C3 7.31331 3.35189 6.15327 4.01118 5.16658C4.67047 4.17989 5.60754 3.41085 6.7039 2.95673C7.80026 2.5026 9.00666 2.38378 10.1755 2.61529C11.3443 2.8468 12.4216 3.41825 13.2426 4.24264C14.0636 5.06702 14.6352 6.14433 14.8667 7.31311C15.0983 8.48189 14.9794 9.68829 14.5253 10.7846C14.0712 11.881 13.302 12.818 12.3154 13.4773C11.3288 14.1366 10.1687 14.4885 8.982 14.4885C7.38246 14.4865 5.84929 13.852 4.72903 12.7317C3.60878 11.6115 2.97425 10.0784 2.9722 8.4788L3 8.5Z" fill="currentColor"/>
        </svg>
      </a>
      <a href="/cart" class="text-gray-700 hover:text-gray-900 relative">
        <svg width="18" height="20" viewBox="0 0 18 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M17 5H13V4C13 2.93913 12.5786 1.92172 11.8284 1.17157C11.0783 0.421427 10.0609 0 9 0C7.93913 0 6.92172 0.421427 6.17157 1.17157C5.42143 1.92172 5 2.93913 5 4V5H1C0.734784 5 0.48043 5.10536 0.292893 5.29289C0.105357 5.48043 0 5.73478 0 6V17C0 17.7956 0.316071 18.5587 0.87868 19.1213C1.44129 19.6839 2.20435 20 3 20H15C15.7956 20 16.5587 19.6839 17.1213 19.1213C17.6839 18.5587 18 17.7956 18 17V6C18 5.73478 17.8946 5.48043 17.7071 5.29289C17.5196 5.10536 17.2652 5 17 5ZM7 4C7 3.46957 7.21071 2.96086 7.58579 2.58579C7.96086 2.21071 8.46957 2 9 2C9.53043 2 10.0391 2.21071 10.4142 2.58579C10.7893 2.96086 11 3.46957 11 4V5H7V4ZM16 17C16 17.2652 15.8946 17.5196 15.7071 17.7071C15.5196 17.8946 15.2652 18 15 18H3C2.73478 18 2.48043 17.8946 2.29289 17.7071C2.10536 17.5196 2 17.2652 2 17V7H4V8C4 8.26522 4.10536 8.51957 4.29289 8.70711C4.48043 8.89464 4.73478 9 5 9C5.26522 9 5.51957 8.89464 5.70711 8.70711C5.89464 8.51957 6 8.26522 6 8V7H12V8C12 8.26522 12.1054 8.51957 12.2929 8.70711C12.4804 8.89464 12.7348 9 13 9C13.2652 9 13.5196 8.89464 13.7071 8.70711C13.8946 8.51957 14 8.26522 14 8V7H16V17Z" fill="currentColor"/>
        </svg>
        {% if cart.item_count > 0 %}
          <span class="absolute -top-2 -right-2 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full">
            {{- cart.item_count -}}
          </span>
        {% endif %}
      </a>
    </div>
  </div>

  <!-- Mobile Menu Button (Hidden on desktop) -->
  <div class="block md:hidden">
    <button
      class="mobile-menu-toggle text-gray-500 hover:text-gray-600 focus:outline-none focus:text-gray-600 p-4"
      aria-label="toggle menu"
    >
      <svg viewBox="0 0 24 24" class="h-6 w-6 fill-current">
        <path fill-rule="evenodd" d="M4 5h16a1 1 0 0 1 0 2H4a1 1 0 1 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2z"></path>
      </svg>
    </button>
  </div>
</header>

<!-- Mobile Navigation (Hidden on desktop) -->
<div class="mobile-menu hidden md:hidden">
  <div class="px-2 pt-2 pb-3 space-y-1">
    {% for link in linklists['main-menu'].links %}
      {% assign dropdown_handle = link.handle | append: '-dropdown' %}
      {% assign has_dropdown = false %}
      {% if linklists[dropdown_handle] != blank %}
        {% assign has_dropdown = true %}
      {% endif %}

      <div class="mobile-link relative">
        <a
          href="{{ link.url }}"
          class="block px-3 py-2 text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50 rounded-md"
        >
          {{ link.title }}
          {% if has_dropdown %}
            <span class="mobile-arrow ml-2">▼</span>
          {% endif %}
        </a>

        {% if has_dropdown %}
          <div class="mobile-dropdown hidden pl-4 pb-2">
            {% for childlink in linklists[dropdown_handle].links %}
              <a
                href="{{ childlink.url }}"
                class="block px-3 py-2 text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50 rounded-md"
              >
                {{ childlink.title }}
              </a>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>
</div>

<!-- CSS to ensure hover works correctly even with small gaps -->
<style>
  .group:hover .group-hover\:block {
    display: block;
  }

  /* Add a small transparent area to prevent the dropdown from closing when moving from link to dropdown */
  .group:after {
    content: '';
    display: block;
    position: absolute;
    height: 20px;
    left: 0;
    right: 0;
    bottom: -20px;
    background: transparent;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Mobile menu toggle
    const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
    const mobileMenu = document.querySelector('.mobile-menu');

    if (mobileMenuToggle && mobileMenu) {
      mobileMenuToggle.addEventListener('click', function () {
        mobileMenu.classList.toggle('hidden');
      });
    }

    // Mobile dropdown toggles
    const mobileLinks = document.querySelectorAll('.mobile-link');

    mobileLinks.forEach((link) => {
      const arrow = link.querySelector('.mobile-arrow');
      const dropdown = link.querySelector('.mobile-dropdown');

      if (arrow && dropdown) {
        arrow.addEventListener('click', function (e) {
          e.preventDefault();
          dropdown.classList.toggle('hidden');
          arrow.textContent = dropdown.classList.contains('hidden') ? '▼' : '▲';
        });
      }
    });
  });
</script>
